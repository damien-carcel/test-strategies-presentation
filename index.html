<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">

<head>
  <meta charset="utf-8"/>

  <title>Test Strategies With Hexagonal Architecture</title>

  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/>
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/>
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/>
  <link rel="manifest" href="/site.webmanifest"/>

  <meta name="description" content="Development in PHP with Docker"/>
  <meta name="author" content="Damien Carcel"/>

  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>

  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui"/>
</head>

<body>
<div class="reveal">
  <div class="slides">

    <section>
      <h2>
        Strat√©gies de test <br>
        et architecture h√©xagonale
      </h2>
    </section>

    <section id="intro">

      <section>
        <h2 class="top-slide-header">Qui suis-je?</h2>

        <div class="centered-slide-content two-columns-slide">
          <div class="col"><img alt="pingoo" src="images/pingoo.png" height="300px">
            <br>
            <b>Damien Carcel</b>
            <br>
            <i>Software Engineer @ Akeneo</i>
          </div>
          <div class="col">
            <br>
            <br>
            <div><img class="vertical-align" alt="github" src="images/github-logo.png" height="50px">&nbsp;<a
              class="vertical-align" href="https://github.com/damien-carcel">damien-carcel</a></div>
            <div><img class="vertical-align" alt="twitter" src="images/mastodon-logo.png" height="50px">&nbsp;<a
              class="vertical-align" href="https://social.tchncs.de/@damiencarcel">@damiencarcel</a></div>
            <div><img class="vertical-align" alt="linkedin" src="images/linkedin-logo.png" height="50px">&nbsp;<a
              class="vertical-align" href="https://www.linkedin.com/in/damien-carcel/">damien-carcel</a></div>
          </div>
        </div>

        <aside class="notes"></aside>
      </section>

    </section>

    <section id="problem">

      <section>
        <h2 class="title">Cas d'usage</h2>

        <div class="centered-slide-content">
          <div class="fragment">Endpoint d'API permettant de cr√©er un utilisateur</div>
          <pre class="fragment"><code class="json">
    POST /users
    {
        "email": "john.doe@email.com",
        "firstname": "John",
        "lastname": "Doe"
    }
          </code></pre>
        </div>

        <aside class="notes"></aside>
      </section>

      <section>
        <h2 class="title">Contr√¥leur</h2>

        <div class="centered-slide-content">
          <pre style="font-size: large"><code class="php">
#[AsController]
#[Route(path: '/users', name: 'create_user', methods: [Request::METHOD_POST])]
final readonly class CreateUserController
{
    public function __construct(private CreateUser $createUser)
    {
    }

    public function __invoke(
        #[MapRequestPayload] CreateUserRequest $createUserRequest,
    ): JsonResponse {
        ($this->createUser)(
             $createUserRequest->email,
             $createUserRequest->firstname,
             $createUserRequest->lastname,
        );

        return new JsonResponse(status: Response::HTTP_CREATED);
    }
}
          </code></pre>
        </div>

        <aside class="notes">Un contr√¥leur aussi simple que possible</aside>
      </section>

      <section>
        <h2 class="title">Service m√©tier</h2>

        <div class="centered-slide-content">
          <pre style="font-size: large"><code class="php">
final readonly class CreateUser
{
    public function __construct(private UserRepository $userRepository)
    {
    }

    public function __invoke(string $email, string $firstname, string $lastname): void
    {
        $user = new User($email, $firstname, $lastname);
        $this->userRepository->save($user);
    }
}
          </code></pre>
        </div>

        <aside class="notes">
          UserRepository::save => entity manager persist + flush.
          Pour l'instant, le service m√©tier ne g√®re pas les edges-cases.
        </aside>
      </section>

      <section>
        <h2 class="title">Le test</h2>

        <div class="centered-slide-content">
          <pre style="font-size: large"><code class="php">
final class CreateUserTest extends KernelTestCase
{
    private CreateUser $createUser;
    private UserRepository $userRepository;

    protected function setUp(): void
    {
        parent::setUp();
        $this->createUser = self::getService(CreateUser::class);
        $this->userRepository = self::getService(UserRepository::class);
    }

    public function testItCreatesAUser(): void
    {
        ($this->createUser)('john.doe@email.com', 'John', 'Doe');

        $retrievedUser = $this->userRepository->getByEmail($userEmail);
        self::assertSame('john.doe@email.com', $retrievedUser->email);
        self::assertSame('John', $retrievedUser->firstname);
        self::assertSame('Doe', $retrievedUser->lastname);
    }
}
          </code></pre>
        </div>

        <aside class="notes">
          On remplace l'appel au service par un call HTTP via le client de test Symfony,
          grace au WebTestCase, et on a un test end-to-end.
        </aside>
      </section>

      <section>
        <h2 class="title">La solution habituelle : les mocks</h2>

        <div class="centered-slide-content">
          <pre style="font-size: large"><code class="php">
    public function testItCreatesAUser(): void
    {
        $userRepository = $this->createMock(UserRepository::class);
        $createUser = new CreateUser($userRepository);

        $userRepository
            ->expects($this->once())
            ->method('save')
            ->with(self::callback(
                static fn (User $user): bool => $user->email === 'john.doe@email.com'
                    && $user->firstname === 'John'
                    && $user->lastname === 'Doe',
            ));

        ($createUser)($userEmail, 'John', 'Doe');
    }
          </code></pre>

          <div class="fragment">Test coupl√© √† l'impl√©mentation.</div>
        </div>

        <aside class="notes"></aside>
      </section>

      <section>
        <h2 class="title">Et si l'utilisateur existe d√©j√†?</h2>

        <div class="centered-slide-content">
          <pre class="fragment" style="font-size: large"><code class="php">
final readonly class CreateUser
{
    public function __invoke(string $email, string $firstname, string $lastname): void
    {
        if ($this->userAlreadyExists($email)) {
            throw new UserAlreadyExists($email);
        }

        $this->userRepository->save(new User($email, $firstname, $lastname));
    }

    private function userAlreadyExists(string $email): bool
    {
        try {
            $this->userRepository->getByEmail($email);
        } catch (UserNotFound) {
            return false;
        }

        return true;
    }
}
          </code></pre>
        </div>

        <aside class="notes"></aside>
      </section>

      <section>
        <h2 class="title">Nouveau test pour nouveau sc√©nario</h2>

        <div class="centered-slide-content">
          <pre style="font-size: large"><code class="php">
    public function testItThrowsAnExceptionIfUserWithSameEmailAlreadyExists(): void
    {
        ($this->createUser)('jane.doe@email.com', 'Jane', 'Doe');

        try {
            ($this->createUser)('jane.doe@email.com', 'John', 'Doe');
        } catch (\Throwable $exception) {
            self::assertInstanceOf(UserAlreadyExists::class, $exception);
            self::assertSame(
                'User with email "jane.doe@email.com" already exist.',
                $exception->getMessage(),
            );

            $existingUser = $this->userRepository->getByEmail('jane.doe@email.com');
            self::assertSame('Jane', $existingUser->firstname);

            return;
        }

        self::fail('An exception should have been thrown.');
    }
          </code></pre>

          <div class="fragment">Mon test fonctionnel pr√©c√©dent fonctionne toujours.</div>
        </div>

        <aside class="notes">
          - Je v√©rifie en BDD que l'utilisateur d'origine n'a pas √©t√© modifi√©.
          - Mon test fonctionnel pr√©c√©dent fonctionne toujours.
        </aside>
      </section>

      <section>
        <h2 class="title">Et avec les mocks ?</h2>

        <div class="centered-slide-content">
          <pre style="font-size: large"><code class="php">
    public function testItThrowsAnExceptionIfUserWithSameEmailAlreadyExists(): void
    {
        $userRepository = $this->createMock(UserRepository::class);
        $createUser = new CreateUser($userRepository);

        $userRepository->expects($this->never())->method('save');
        $userRepository
            ->expects($this->once())
            ->method('getByEmail')
            ->with('jane.doe@email.com')
            ->willReturn(new User('jane.doe@email.com', 'Jane', 'Doe'));

        $this->expectException(UserAlreadyExists::class);
        $this->expectExceptionMessage('User with email "jane.doe@email.com" already exist.');
        ($createUser)('jane.doe@email.com', 'John', 'Doe');
    }
          </code></pre>

          <div class="fragment">Mon test pr√©c√©dent ne fonctionne plus üòû.</div>
        </div>

        <aside class="notes">
          - Je dois v√©rifier que "save" n'est pas appel√©, car je ne peux pas aller en BDD v√©rifier que l'utilisateur n'a
          pas √©t√© modifi√©.
          - Je dois mocker un nouvel appel √† "getByEmail" => couplage.
          - Si quelque chose ne va pas avec le repository, ce test ne le montrera jamais.
        </aside>
      </section>

      <section>
        <h2 class="title">Test avec mocks = couplage</h2>

        <div class="centered-slide-content">
          <pre style="font-size: large"><code class="php" data-line-numbers="6-12">
    public function testItCreatesAUser(): void
    {
        $userRepository = $this->createMock(UserRepository::class);
        $createUser = new CreateUser($userRepository);

        $userRepository
            ->expects($this->once())
            ->method('getByEmail')
            ->with($userEmail)
            ->willThrowException(new UserNotFound($userEmail));

        $userRepository
            ->expects($this->once())
            ->method('save')
            ->with(self::callback(
                static fn (User $user): bool => $user->email === 'john.doe@email.com'
                    && $user->firstname === 'John'
                    && $user->lastname === 'Doe',
            ));

        ($createUser)($userEmail, 'John', 'Doe');
    }
          </code></pre>
        </div>

        <aside class="notes">
          - Mon test pr√©c√©dent ne fonctionne plus, car il a besoin du nouveau mock lui aussi.
        </aside>
      </section>

    </section>

    <section id="solution">

      <section>
        <h2 class="title">C'est quoi un "bon" test ?</h2>

        <div class="centered-slide-content">
          <div class="fragment"><br><b>F.I.R.S.T.</b></div>
          <br>
          <ul>
            <li class="fragment"><b>F</b>ast : on veut un retour succ√®s/√©chec rapide</li>
            <li class="fragment"><b>I</b>solated : teste une chose et une seule, pas d'effets de bord</li>
            <li class="fragment"><b>R</b>epeatable : un test doit √™tre stable</li>
            <li class="fragment"><b>S</b>elf-validating : pas de doute sur le succ√®s ou l'√©chec</li>
            <li class="fragment"><b>T</b>hourough : couvre tout le m√©tier</li>
          </ul>
        </div>

        <aside class="notes">
          - Rapide, isol√©, r√©p√©table, auto-validant, approfondi/opportun.
          - Effets de bords = couplage.
          - Self-validating : si une refacto casse votre test, alors il n'est pas auto-validant. Donc il ne doit pas
          √™tre coupl√©.
        </aside>
      </section>

      <section>
        <h2 class="title">C'est quoi un "bon" test ?</h2>

        <div class="centered-slide-content">
          <div class="fragment"><br>Focalis√© sur le m√©tier</div>
          <div class="fragment"><br>Simple</div>
        </div>

        <aside class="notes">
          - Simple => un test doit pouvoir servir de documentation du m√©tier
          - Des mocks qu'on doit changer au cours du d√©veloppement n'aident pas √† cette simplicit√©
        </aside>
      </section>

      <section>
        <h2 class="title">Il n'y a pas que les mocks dans la vie</h2>

        <div class="centered-slide-content">
          <div class="fragment"><b>Doublures (test doubles)</b></div>
          <br>
          <ul>
            <li class="fragment">Stub : simple description</li>
            <li class="fragment">Mock : doit √™tre ex√©cut√©</li>
            <li class="fragment">Spy : v√©rification apr√®s ex√©cution</li>
            <li class="fragment">‚Ä¶</li>
            <li class="fragment">Double en m√©moire</li>
          </ul>
        </div>

        <aside class="notes">
          - Le double en m√©moire est une vraie impl√©mentation, pleinement fonctionnelle, contrairement aux mocks, stubs
          et spies.
        </aside>
      </section>

      <section>
        <h2 class="title">L'architecture hexagonale</h2>

        <div class="centered-slide-content">
          <img class="fragment" alt="hexagonal.png" src="images/hexagonal.png"/>
        </div>

        <aside class="notes">
          - Cr√©√©e en 2005 par Alistair Cockburn (pronounced C≈çburn)
          - C√¥t√© gauche : contr√¥leur, c√¥t√© droit = contr√¥l√© => inversion de d√©pendance
          - Les d√©tails d'impl√©mentation vont dans les adaptateurs, hors de la logique m√©tier
          - Les tests peuvent √™tre vu comme un adaptateur contr√¥lant
          - Oubliez les layers multiples, ce n'est pas de la clean architecture
          - Ce n'est pas non plus du DDD ou du CQRS
        </aside>
      </section>

      <section>
        <h2 class="title">Exemple d'adaptateurs</h2>

        <div class="centered-slide-content">
          <pre style="font-size: large"><code class="php">
final class DatabaseUserRepository extends ServiceEntityRepository implements UserRepository
{
    public function __construct(ManagerRegistry $registry)
    {
        parent::__construct($registry, User::class);
    }

    public function save(User ...$users): void
    {
        foreach ($users as $user) {
            $this->getEntityManager()->persist($user);
        }
        $this->getEntityManager()->flush();
    }
}
          </code></pre>
        </div>

        <aside class="notes">
          - L'interface est le "port".
        </aside>
      </section>

      <section>
        <h2 class="title">Exemple d'adaptateurs</h2>

        <div class="centered-slide-content">
          <pre style="font-size: large"><code class="php">
final class InMemoryUserRepository implements UserRepository
{
    /** @var User[] */
    private array $users = [];

    public function save(User ...$users): void
    {
        foreach ($users as $user) {
            $this->users[] = clone $user;
        }
    }
}
          </code></pre>
        </div>

        <aside class="notes"></aside>
      </section>

      <section>
        <h2 class="title">Tester les adaptateurs</h2>

        <div class="centered-slide-content">
          <pre style="font-size: large"><code class="php">
final class UserRepositoryTest extends AbstractIntegrationTestCase
{
    private readonly UserRepository $repository;

    protected function setUp(): void
    {
        parent::setUp();
        $this->repository = self::getService(UserRepository::class);
    }

    #[Group('with-in-memory-adapters')]
    #[Group('with-production-adapters')]
    public function testItSavesAUser(): void
    {
        $user = new User('john.doe@email.com', 'John', 'Doe');

        $this->repository->save($user);

        $this->assertUserIsStored($user);
    }
}
          </code></pre>
        </div>

        <aside class="notes">
          - Test d'int√©gration => int√©gration avec les √©l√©mentes ext√©rieurs √† l'application (syst√®me de fichier, base de
          donn√©e, etc.)
          - /!\ Un seul test pour tous les adaptateurs d'un m√™me port => garantie la fiabilit√© de l'impl√©mentation "in
          memory"
          - Le repo doit √™tre correctement test√© : Thourough !
        </aside>
      </section>

      <section>
        <h2 class="title">Tester les adaptateurs</h2>

        <div class="centered-slide-content">
          <pre style="font-size: large"><code class="php">
abstract class AbstractIntegrationTestCase extends KernelTestCase
{
    protected static function bootKernel(array $options = []): KernelInterface
    {
        $testEnvironment = self::getCurrentTestEnvironment();

        if (!\in_array($testEnvironment, ['memory', 'test'], true)) {
            throw new \RuntimeException(
                "Invalid TEST_ENV environment variable value \"$testEnvironment\".,
            );
        }

        $options = array_merge($options, ['environment' => $testEnvironment]);

        return parent::bootKernel($options);
    }
}
          </code></pre>
        </div>

        <aside class="notes"></aside>
      </section>

      <section>
        <h2 class="title">Tester le m√©tier unitairement</h2>

        <div class="centered-slide-content">
          <pre style="font-size: large"><code class="php">
    public function testItCreatesAUser(): void
    {
        $userRepository = new InMemoryUserRepository();
        $createUser = new CreateUser($userRepository);

        ($createUser)('john.doe@email.com', 'John', 'Doe');

        $retrievedUser = $userRepository->getByEmail('john.doe@email.com');
        self::assertSame($userEmail, $retrievedUser->email);
        self::assertSame('John', $retrievedUser->firstname);
        self::assertSame('Doe', $retrievedUser->lastname);
    }
          </code></pre>
        </div>

        <aside class="notes">
          - Pas de couplage avec l'impl√©mentation
          - Ce test ne cassera pas lors de l'ajout de fonctionnalit√©s comme v√©rifier si un utilisateur existe d√©j√† =>
          isol√© et auto-validant
        </aside>
      </section>

      <section>
        <h2 class="title">Et avec le framework ?</h2>

        <div class="centered-slide-content">
          <pre class="fragment" style="font-size: large"><code class="php">
final class CreateUserTest extends AbstractAcceptanceTestCase
{
    private CreateUser $createUser;
    private UserRepository $userRepository;

    protected function setUp(): void
    {
        parent::setUp();
        $this->createUser = self::getService(CreateUser::class);
        $this->userRepository = self::getService(UserRepository::class);
    }

    public function testItCreatesAUser(): void
    {
        ($this->createUser)('john.doe@email.com', 'John', 'Doe');

        $retrievedUser = $this->userRepository->getByEmail($userEmail);
        self::assertSame('john.doe@email.com', $retrievedUser->email);
        self::assertSame('John', $retrievedUser->firstname);
        self::assertSame('Doe', $retrievedUser->lastname);
    }
}
          </code></pre>

          <div class="fragment">Tests "d'acceptance"</div>
        </div>

        <aside class="notes"></aside>
      </section>

      <section>
        <h2 class="title">Et avec le framework ?</h2>

        <div class="centered-slide-content">
          <pre style="font-size: large"><code class="php">
abstract class AbstractAcceptanceTestCase extends KernelTestCase
{
    protected static function bootKernel(array $options = []): KernelInterface
    {
        $options = array_merge($options, ['environment' => 'memory']);

        return parent::bootKernel($options);
    }
}
          </code></pre>
          <pre class="fragment" style="font-size: large"><code class="yaml">
# config/services.yaml
when@memory:
    services:
        App\Domain\Repository\UserRepository:
            class: App\Infrastructure\Persistence\InMemory\InMemoryUserRepository
          </code></pre>
        </div>

        <aside class="notes">
          - Permet de tester en condition plus proches de la production que les tests unitaires.
          - [Bonus] Send an e-mail to the user to notify them their account was created.
        </aside>
      </section>

      <section>
        <h2 class="title">Choisir le "bon" type de test</h2>

        <div class="centered-slide-content">
          <ul>
            <li class="fragment">Unitaire : pour tout ce qui est strictement dans votre hexagone</li>
            <li class="fragment">Acceptance : pour le code m√©tier qui int√©ragit avec les ports</li>
            <li class="fragment">Integration : pour vos adaptateurs</li>
            <li class="fragment">End-to-end : scenarios critiques</li>
          </ul>
        </div>

        <aside class="notes">
          - Le end-to-end est le plus couteux, √† utiliser avec mod√©ration.
        </aside>
      </section>

    </section>

    <section id="conclusion">

      <section>
        <h2 class="title">Conclusion</h2>

        <div class="centered-slide-content">
          <ul>
            <li class="fragment">Doubles "in memory" = tests m√©tier rapides et fiables</li>
            <li class="fragment">Pas d'effets de bords lors de refactorisation de code</li>
            <li class="fragment">Assure le respect des r√®gles m√©tier</li>
          </ul>
        </div>

        <aside class="notes"></aside>
      </section>

      <section>
        <h2 class="title">No silver bullet</h2>

        <div class="centered-slide-content">
          <ul>
            <li class="fragment">Requiert un bon design du code avec des s√©parations claires</li>
            <li class="fragment">Plusieurs types de tests</li>
            <li class="fragment">Impl√©mentation "in memory" syst√©matique pour tous les ports contr√¥l√©s</li>
            <li class="fragment">Pas appliquable sur tout, par exemple requ√™tes de lecture complexes</li>
          </ul>
        </div>

        <aside class="notes"></aside>
      </section>

      <section>
        <div class="centered-slide-content thank-you">Merci de votre attention</div>
      </section>

    </section>

  </div>
</div>

<script type="module" src="/main.js"></script>
</body>

</html>
